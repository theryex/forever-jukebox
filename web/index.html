<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Forever Jukebox</title>
    <style>
      html.app-loading body {
        opacity: 0;
      }
      html.app-loading #app {
        visibility: hidden;
      }
    </style>
    <script>
      document.documentElement.classList.add("app-loading");
    </script>
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Tilt+Neon&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,200..700,0..1,-50..200"
      rel="stylesheet"
    />
  </head>
  <body>
    <div id="app">
      <header class="hero">
        <div class="hero-actions">
          <div class="theme-toggle" id="theme-toggle">
            <span>Theme:</span>
            <button type="button" class="theme-link" data-theme="light">
              Light
            </button>
            <span class="theme-sep">|</span>
            <button type="button" class="theme-link" data-theme="dark">
              Dark
            </button>
          </div>
        </div>
        <div class="hero-main">
          <div class="hero-title">
            <h1 class="hero-title-neon">THE FOREVER JUKEBOX</h1>
          </div>
          <nav class="tabs" aria-label="Primary">
            <button class="tab-btn active" data-tab-button="top">
              Top Songs
            </button>
            <button class="tab-btn" data-tab-button="search">Search</button>
            <button class="tab-btn" data-tab-button="play" disabled>
              Listen
            </button>
            <button class="tab-btn" data-tab-button="faq">FAQ</button>
          </nav>
        </div>
      </header>
      <section class="panel tab-panel" data-tab-panel="top">
        <div class="subtabs" id="top-subtabs">
          <button class="subtab-btn active" data-top-subtab="top">
            Top Songs
          </button>
          <span class="subtab-spacer" aria-hidden="true"></span>
          <button class="subtab-btn" data-top-subtab="favorites">
            Favorites
          </button>
        </div>
        <div class="panel-title panel-title-row">
          <span id="top-list-title">Top Songs</span>
          <div class="favorites-sync">
            <button
              id="favorites-sync-button"
              class="favorites-sync-button hidden"
              type="button"
              aria-label="Favorites sync"
              aria-haspopup="menu"
              aria-expanded="false"
            >
              <span
                class="material-symbols-outlined favorites-sync-icon"
                aria-hidden="true"
                >cloud_upload</span
              >
            </button>
            <div
              class="favorites-sync-menu hidden"
              id="favorites-sync-menu"
              role="menu"
            >
              <button
                type="button"
                class="favorites-sync-item hidden"
                data-favorites-sync="refresh"
              >
                Refresh favorites
              </button>
              <button
                type="button"
                class="favorites-sync-item"
                data-favorites-sync="create"
              >
                Create sync code
              </button>
              <button
                type="button"
                class="favorites-sync-item"
                data-favorites-sync="enter"
              >
                Enter sync code
              </button>
            </div>
          </div>
        </div>
        <ol class="top-list" id="top-songs">
          Loading top songs…
        </ol>
        <ol class="top-list favorites-list hidden" id="favorites-list">
          No favorites yet.
        </ol>
      </section>
      <section class="panel tab-panel hidden" data-tab-panel="search">
        <div class="subtabs hidden" id="search-subtabs">
          <button class="subtab-btn active" data-search-subtab="search">
            Search
          </button>
          <span class="subtab-spacer" aria-hidden="true"></span>
          <button class="subtab-btn" data-search-subtab="upload">Upload</button>
        </div>
        <div class="panel-title" id="search-panel-title">Search</div>
        <div class="search-panel" id="search-panel">
          <div class="search-hint" id="search-hint">
            Step 1: Find a Spotify track.
          </div>
          <div class="search-bar">
            <input
              id="search-input"
              class="search-input"
              type="search"
              placeholder="Search by artist or track"
              autocomplete="off"
            />
            <button id="search-button">Search</button>
          </div>
          <div class="search-results" id="search-results">
            Search results will appear here.
          </div>
        </div>
        <div class="upload-panel hidden" id="upload-panel">
          <div class="upload-section hidden" id="upload-file-section">
            <div class="upload-title">Upload by File</div>
            <div class="upload-hint" id="upload-file-hint"></div>
            <div class="search-bar">
              <input id="upload-file-input" class="search-input" type="file" />
              <button id="upload-file-button">Load</button>
            </div>
          </div>
          <div class="upload-section hidden" id="upload-youtube-section">
            <div class="upload-title">Upload by YouTube URL</div>
            <div class="search-bar">
              <input
                id="upload-youtube-input"
                class="search-input"
                type="url"
                placeholder="https://www.youtube.com/watch?v=..."
                autocomplete="off"
              />
              <button id="upload-youtube-button">Load</button>
            </div>
          </div>
        </div>
      </section>
      <section class="panel tab-panel hidden" data-tab-panel="play">
        <div class="panel" id="play-status">
          <div class="status-row">
            <div
              class="spinner hidden"
              id="analysis-spinner"
              aria-hidden="true"
            ></div>
            <div class="status-progress" id="analysis-progress"></div>
            <div class="status-text" id="analysis-status">
              Select a track to begin.
            </div>
          </div>
        </div>
        <div class="play-title" id="play-title"></div>
        <div class="menu-bar hidden" id="play-menu">
          <div class="menu-left">
            <button id="play" class="play-toggle hidden" aria-label="Play">
              <span
                class="material-symbols-outlined play-icon"
                aria-hidden="true"
                >play_arrow</span
              >
              <span class="play-text">Play</span>
            </button>
          </div>
          <div class="menu-right">
            <button
              id="delete-job"
              class="delete-toggle hidden"
              aria-label="Delete within 30 minutes of creation"
              title="Delete within 30 minutes of creation"
            >
              <span
                class="material-symbols-outlined delete-icon"
                aria-hidden="true"
                >delete</span
              >
            </button>
            <button id="tuning" class="tune-toggle" aria-label="Tune">
              <span
                class="material-symbols-outlined tune-icon"
                aria-hidden="true"
                >tune</span
              >
            </button>
            <button id="track-info" class="info-toggle" aria-label="Info">
              <span
                class="material-symbols-outlined info-icon"
                aria-hidden="true"
                >info</span
              >
            </button>
            <button id="short-url" class="copy-toggle" aria-label="Copy link">
              <span
                class="material-symbols-outlined copy-icon"
                aria-hidden="true"
                >share</span
              >
            </button>
            <button
              id="favorite-toggle"
              class="favorite-toggle"
              aria-label="Favorite"
            >
              <span
                class="material-symbols-outlined favorite-icon"
                aria-hidden="true"
                >star</span
              >
            </button>
          </div>
        </div>
        <div id="viz-panel" class="hidden">
          <div id="jukebox-viz" class="viz">
            <div id="viz-layer" class="viz-layer"></div>
            <div id="canonizer-layer" class="canonizer-layer"></div>
            <div class="viz-top">
              <div class="viz-actions">
                <span class="viz-label">Mode:</span>
                <button class="viz-btn active" data-play-mode="jukebox">
                  Jukebox
                </button>
                <button class="viz-btn" data-play-mode="autocanonizer">
                  Autocanonizer
                </button>
              </div>
              <div class="viz-controls">
                <span class="viz-label">Visualization:</span>
                <button class="viz-btn active" data-viz="0">1</button>
                <button class="viz-btn" data-viz="1">2</button>
                <button class="viz-btn" data-viz="2">3</button>
                <button class="viz-btn" data-viz="3">4</button>
                <button class="viz-btn" data-viz="4">5</button>
                <button class="viz-btn" data-viz="5">6</button>
              </div>
              <div class="canonizer-finish">
                <input type="checkbox" id="canonizer-finish" />
                <span>Finish out the song</span>
              </div>
            </div>
            <div class="viz-bottom" id="viz-stats">
              <div class="viz-bottom-left">
                <button
                  id="viz-play"
                  class="play-toggle viz-play-toggle"
                  aria-label="Play"
                >
                  <span
                    class="material-symbols-outlined play-icon"
                    aria-hidden="true"
                    >play_arrow</span
                  >
                  <span class="play-text">Play</span>
                </button>
                <div class="viz-info">
                  <div class="viz-title" id="viz-now-playing">
                    The Forever Jukebox
                  </div>
                  <div class="viz-meta">
                    <span>Listen Time:</span>
                    <span id="listen-time">00:00:00</span>
                    <span id="viz-beats-divider" class="viz-divider">·</span>
                    <span id="viz-beats-label">Total Beats:</span>
                    <span id="beats-played">0</span>
                  </div>
                </div>
              </div>
              <button
                id="fullscreen"
                class="fullscreen-toggle"
                aria-label="Fullscreen"
              >
                <span
                  class="material-symbols-outlined fullscreen-icon"
                  aria-hidden="true"
                  >fullscreen</span
                >
              </button>
            </div>
          </div>
        </div>
      </section>
      <section class="panel tab-panel hidden" data-tab-panel="faq">
        <div class="panel-title">FAQ</div>
        <div class="faq">
          <h4>What the what?</h4>
          <p>
            The Forever Jukebox is an open-source modernization of the
            <a
              href="https://musicmachinery.com/2012/11/12/the-infinite-jukebox/"
              target="_blank"
              rel="noreferrer"
              >Infinite Jukebox</a
            >
            and
            <a
              href="https://musicmachinery.com/2014/03/18/how-the-autocanonizer-works/"
              target="_blank"
              rel="noreferrer"
              >Autocanonizer</a
            >
            (Paul Lamere) — rebuilt from the ground up and launched on January
            1, 2026 by
            <a href="https://creighton.dev" target="_blank" rel="noreferrer"
              >Creighton Linza</a
            >. It generates a forever-evolving version of any song.
          </p>

          <h4>How does it work?</h4>
          <p>
            The app uses the Spotify Web API for track search/metadata and
            YouTube as the audio source. The audio is processed by the Forever
            Jukebox Analysis Engine, which approximates Spotify’s legacy Echo
            Nest analysis (now deprecated) by extracting beats, segments, and
            related features. Those features drive beat-synchronous playback in
            the frontend. On each beat, the player may jump to a different,
            sonically similar point in the track based on timbre, loudness,
            segment duration, and beat position. The visualizations map these
            potential jump paths for every beat.
          </p>
          <p>
            The full source code is available in the
            <a
              href="https://github.com/creightonlinza/forever-jukebox/"
              target="_blank"
              rel="noreferrer"
              >forever-jukebox</a
            >
            repository.
          </p>

          <h4>How can I tune the Jukebox?</h4>
          <ul>
            <li>Click the Tune button to open the tuning panel.</li>
            <li>
              Lower the threshold for higher audio continuity; raise it for more
              branches.
            </li>
            <li>
              Adjust branch probability min/max and ramp speed to shape how
              often jumps happen.
            </li>
            <li>
              Use the checkboxes to allow or restrict certain branch types.
            </li>
            <li>
              Click a branch in the visualization, then press Delete to remove
              it.
            </li>
          </ul>

          <h4>How do Favorites work?</h4>
          <ul>
            <li>
              Favorites are saved/unsaved by clicking the star icon on a song.
              They are stored locally in your browser and can optionally be
              synced across devices using a sync code obtained from the
              Favorites sync menu.
            </li>
            <li>
              When you favorite a song, its tuning and deleted branches are
              saved too, so future loads restore your chosen parameters.
            </li>
            <li>
              Use Reset in the Tune panel to restore default tuning and
              deleted branches (must be re-favorited to save changes).
            </li>
          </ul>

          <h4>Credits</h4>
          <ul>
            <li>Original inspiration: Paul Lamere and the Infinite Jukebox.</li>
            <li>EternalJukebox: keeping the dream alive.</li>
            <li>madmom: beat and downbeat tracking.</li>
            <li>Essentia: audio features and DSP toolkits.</li>
          </ul>

          <h4>Help! Something broke! / I have an idea!</h4>
          <p>
            Please file issues and feature requests here:
            <a
              href="https://github.com/creightonlinza/forever-jukebox/issues/new"
              target="_blank"
              rel="noreferrer"
              >Create an issue</a
            >.
          </p>

          <h4>CACHED AUDIO</h4>
          <button id="cached-audio-clear" type="button">Clear 0MB</button>
        </div>
      </section>
      <div id="tuning-modal" class="modal">
        <div class="modal-panel">
          <div class="modal-header">
            <h2>Tuning</h2>
            <button id="tuning-close" class="modal-close" aria-label="Close">
              <span
                class="material-symbols-outlined modal-close-icon"
                aria-hidden="true"
                >close</span
              >
            </button>
          </div>
          <div class="modal-body">
            <label>
              Branch Similarity Threshold: <span id="threshold-val">0</span>
              <input
                id="threshold"
                type="range"
                min="0"
                max="80"
                step="5"
                value="0"
              />
            </label>
            <div class="hint">
              Computed threshold: <span id="computed-threshold">-</span>
            </div>
            <label>
              Branch Probability Min: <span id="min-prob-val">18%</span>
              <input
                id="min-prob"
                type="range"
                min="0"
                max="100"
                step="1"
                value="18"
              />
            </label>
            <label>
              Branch Probability Max: <span id="max-prob-val">50%</span>
              <input
                id="max-prob"
                type="range"
                min="0"
                max="100"
                step="1"
                value="50"
              />
            </label>
            <label>
              Branch Ramp Speed: <span id="ramp-val">10%</span>
              <input
                id="ramp"
                type="range"
                min="0"
                max="100"
                step="5"
                value="10"
              />
            </label>
            <label>
              Volume: <span id="volume-val">50</span>
              <input
                id="volume"
                type="range"
                min="0"
                max="100"
                step="5"
                value="50"
              />
            </label>
            <div class="checkbox-row">
              <label
                ><input id="last-edge" type="checkbox" checked /> Loop extension
                optimization</label
              >
              <label
                ><input id="just-backwards" type="checkbox" /> Allow only
                reverse branches</label
              >
              <label
                ><input id="just-long" type="checkbox" /> Allow only long
                branches</label
              >
              <label
                ><input id="remove-seq" type="checkbox" /> Remove sequential
                branches</label
              >
            </div>
          </div>
          <div class="modal-footer tuning-footer">
            <button id="tuning-reset">Reset</button>
            <button id="tuning-apply">Apply</button>
          </div>
        </div>
      </div>
      <div id="info-modal" class="modal">
        <div class="modal-panel">
          <div class="modal-header">
            <h2>Track Info</h2>
            <button id="info-close" class="modal-close" aria-label="Close">
              <span
                class="material-symbols-outlined modal-close-icon"
                aria-hidden="true"
                >close</span
              >
            </button>
          </div>
          <div class="modal-body info-body">
            <div class="info-row">
              <span class="info-label">Song length:</span>
              <span id="info-duration">00:00:00</span>
            </div>
            <div class="info-row">
              <span class="info-label">Total beats:</span>
              <span id="info-beats">0</span>
            </div>
            <div class="info-row">
              <span class="info-label">Total branches:</span>
              <span id="info-branches">0</span>
            </div>
            <div class="info-row">
              <span class="info-label">Deleted branches:</span>
              <span id="info-deleted-branches">0</span>
            </div>
            <h4>Keyboard commands</h4>
            <div class="info-row">
              <span class="info-label">Space:</span>
              <span>Start/stop playback (Listen tab)</span>
            </div>
            <div class="info-row">
              <span class="info-label">Shift (hold):</span>
              <span>Force branching while playing</span>
            </div>
            <div class="info-row">
              <span class="info-label">Delete:</span>
              <span>Remove a selected branch</span>
            </div>
          </div>
        </div>
      </div>
      <div id="favorites-sync-enter-modal" class="modal">
        <div class="modal-panel">
          <div class="modal-header">
            <h2>Favorites Sync</h2>
            <button
              id="favorites-sync-enter-close"
              class="modal-close"
              aria-label="Close"
            >
              <span
                class="material-symbols-outlined modal-close-icon"
                aria-hidden="true"
                >close</span
              >
            </button>
          </div>
          <div class="modal-body">
            <p class="modal-hint">
              Enter the 3-word sync code to pull down your favorites.
            </p>
            <input
              id="favorites-sync-enter-input"
              class="search-input"
              type="text"
              placeholder="the-forever-jukebox"
              autocomplete="off"
            />
            <p
              id="favorites-sync-enter-status"
              class="modal-status hidden"
              role="status"
              aria-live="polite"
            ></p>
          </div>
          <div class="modal-footer">
            <button id="favorites-sync-enter-button" type="button">
              Sync favorites
            </button>
          </div>
        </div>
      </div>
      <div id="favorites-sync-create-modal" class="modal">
        <div class="modal-panel">
          <div class="modal-header">
            <h2>Favorites Sync</h2>
            <button
              id="favorites-sync-create-close"
              class="modal-close"
              aria-label="Close"
            >
              <span
                class="material-symbols-outlined modal-close-icon"
                aria-hidden="true"
                >close</span
              >
            </button>
          </div>
          <div class="modal-body">
            <p class="modal-hint" id="favorites-sync-create-hint">
              Create a sync code to share your favorites between devices.
            </p>
            <div
              id="favorites-sync-create-output"
              class="favorites-sync-code hidden"
            ></div>
            <p
              id="favorites-sync-create-status"
              class="modal-status hidden"
              role="status"
              aria-live="polite"
            ></p>
          </div>
          <div class="modal-footer">
            <button id="favorites-sync-create-button" type="button">
              Create sync code
            </button>
          </div>
        </div>
      </div>
      <footer class="site-footer">
        <p>
          The Forever Jukebox &amp; Analysis Engine by
          <a href="https://creighton.dev" target="_blank" rel="noreferrer"
            >Creighton</a
          >. Based off of
          <a href="https://musicmachinery.com/" target="_blank" rel="noreferrer"
            >Paul Lamere</a
          >'s original Infinite Jukebox.
        </p>
      </footer>
    </div>
    <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
